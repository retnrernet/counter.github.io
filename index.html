<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"> 
  <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
</head>
<body>
  <div>Дата сегодня:<u><label id='time'></label></u></div><button id="clean" type="submit" pys-onClick="clean">Закрыть месяц</button><br>
  <div>Введите название изделия и тип операции или выберите из списка</div>
  <select name="izdelia" id="izdelia">
    <option value="Комбинезон">Комбинезон</option>
    <option value="Юбка">Юбка</option>
    <option value="Лосины">Лосины</option>
    <option value="Леггинсы">Леггинсы</option>
    <option value="Платье">Платье</option>
    <option value="Ражгард">Ражгард</option>
    <option value="Водолазка">Водолазка</option>
    <option value="Шорты">Шорты</option>
    <option value="Футболка">Футболка</option>
    <option value="Топ">Топ</option>
    <option value="Велосипедка">Велосипедка</option>
    <option value="Купальник">Купальник</option>
    <option value="Брюки">Брюки</option>
    <option value="Бюстгалтер">Бюстгалтер</option>
    <option value="Трусы">Трусы</option>
    <option value="Сарафан">Сарафан</option>
    <option value="Боди">Боди</option>
    <option value="Иное">Иное</option>
  </select>
  <select name="operation" id="operation">
    <option value="Обметать боковые срезы">Обметать боковые срезы</option>
    <option value="Вывести концы нитей, протянуть эласт">Вывести концы нитей</option>
    <option value="Стачать эластичную ленту">Стачать эластичную ленту</option>
    <option value="Разложить припуск шва">Разложить припуск шва</option>
    <option value="Наметить место размерника">Наметить место размерника</option>
    <option value="Настрочить размерник">Настрочить размерник</option>
    <option value="Приложить отделочную строчку">Приложить отделочную строчку</option>
    <option value="Наметить контрольные точки">Наметить контрольные точки</option>
    <option value="Настрочить фирмичку">Настрочить фирмичку</option>
    <option value="Закрепить верхнюю часть">Закрепить верхнюю часть</option>
    <option value="Притачать составник">Притачать составник</option>
    <option value="Поставить П-образные закрепки">Поставить П-образные закрепки</option>
    <option value="Скрепить деталь полочки верха">Скрепить деталь полочки верха</option>
    <option value="Вложить боковые срезы">Вложить боковые среды</option>
    <option value="Иное">Иное</option>
  </select>
  <input type="name" id="name"/>
  <div>Введите количество</div>
  <input type="num" id="num"/>
  <div>Введите стоимость за единицу (в формате 0.5 или 5)</div>
  <input type="price" id="price"/>
  <button id="submit-button" type="submit" pys-onClick="my_function">OK</button><br><br>
  <div>Ранее:</div><br>
  <div id="output"></div><br>
  <table>
    <tr>
      <th>Заработано за месяц</th>
      <th>Заработано всего</th>
      <th>Сшито за месяц</th>
      <th>ТОП операция</th>
    </tr>
    <tr>
      <td id="month"></td>
      <td id="full"></td>
      <td id="sewed"></td>
      <td id="top"></td>
    </tr>
  </table>
  <iframe src="https://onlineocr.org/ru#ocr_load" width="100%" height="500" scrolling="no"></iframe><br>
  <div>Вставьте распознанный текст:</div>
  <input type="text" id="text"/><br>
  <button id="ocrbtn" type="submit" pys-onClick="ocr">Сравнить</button><br>
  <div id="ocr"></div><br>
  <div>Архив:</div>
  <div id="archive"></div><br>
  <button id="download" type="submit" pys-onClick="down">Скачать базу</button>
<py-script>
  from datetime import datetime;import js;from js import document, console,URL, Uint8Array, window, File, Object;from collections import Counter
  now = datetime.now()
  Element('time').element.innerText = now.strftime("%d/%m/%Y")
  try:Element('output').element.innerText = js.localStorage.getItem("ss");Element('full').element.innerText = js.localStorage.getItem("full");Element('month').element.innerText = js.localStorage.getItem("month");Element('archive').element.innerText = js.localStorage.getItem("archive")
  except:pass
  try:
    #txt=''.join([i for i in js.localStorage.getItem("ss").splitlines() if not i.isdigit()])
    Counter = Counter(js.localStorage.getItem("ss").split())
    Element('top').element.innerText = Counter.most_common(4)[0]
  except:pass
  def ocr(*args, **kwargs):
    if js.localStorage.getItem("ss").split() in Element('text').element.value.split():Element('ocr').element.innerText = "найдено совпадение"
    else: Element('ocr').element.innerText = "не найдено совпадение"
  def my_function(*args, **kwargs):
    name = Element('name').element.value
    num = Element('num').element.value
    price = Element('price').element.value
    izdelia= Element('izdelia').element.value
    operation= Element('operation').element.value
    #try:
    #  if izdelia+", "+operation in js.localStorage.getItem("ss"):
    #    lines=js.localStorage.getItem("ss").splitlines()
    #    for line in lines:
    #      if line.startswith(izdelia+", "+operation):
    #        text=text.replace(",","").replace(".0","").replace(".1","").replace(".2","").replace(".3","").replace(".4","").replace(".5","").replace(".6","").replace(".7","").replace(".8","").replace(".9","").split()
    #        nums=[(c) for i,c in enumerate(text) if c.isdigit()]
    #        n1=int(nums[0])+int(num)
    #        n2=int(nums[2])+(int(num)+int(float(price)))
    #        final=line.replace(nums[0],str(n1)).replace(nums[2],str(n2))
    #        js.localStorage.setItem("ss",js.localStorage.getItem("ss").replace(line, final))
    #  else:
    #    try:js.localStorage.setItem("ss", js.localStorage.getItem("ss")+"\n"+izdelia+", "+operation+", "+name+", "+num+" штук, расценка "+price+", "+str(int(num)*float(price))+" руб. итоговая выручка, дата"+now.strftime("%d/%m/%Y"))
    #    except:js.localStorage.setItem("ss",izdelia+", "+operation+", "+name+", "+num+" штук, расценка "+price+", "+str(int(num)*float(price))+" руб. итоговая выручка, дата"+now.strftime("%d/%m/%Y"))
    #except:
    try:js.localStorage.setItem("ss", js.localStorage.getItem("ss")+"\n"+izdelia+", "+operation+", "+name+", "+num+" штук, расценка "+price+", "+str(int(num)*float(price))+" руб. итоговая выручка, дата"+now.strftime("%d/%m/%Y"))
    except:js.localStorage.setItem("ss",izdelia+", "+operation+", "+name+", "+num+" штук, расценка "+price+", "+str(int(num)*float(price))+" руб. итоговая выручка, дата"+now.strftime("%d/%m/%Y"))
    Element('output').element.innerText = js.localStorage.getItem("ss")
    try:js.localStorage.setItem("full", float(js.localStorage.getItem("full"))+(int(num)*float(price)))
    except:js.localStorage.setItem("full", int(num)*float(price))
    Element('full').element.innerText = js.localStorage.getItem("full")
    try:js.localStorage.setItem("month", float(js.localStorage.getItem("month"))+(int(num)*float(price)))
    except:js.localStorage.setItem("month", int(num)*float(price))
    Element('month').element.innerText = js.localStorage.getItem("month")
  def clean(*args, **kwargs):
    js.localStorage.setItem('archive', js.localStorage.getItem('ss'));js.localStorage.removeItem('ss');js.localStorage.removeItem('month')
    Element('archive').element.innerText = js.localStorage.getItem("archive")
  def down(*args, **kwargs):
    encoded_data = js.localStorage.getItem("ss").encode('utf-8')
    my_stream = io.BytesIO(encoded_data)
    js_array = Uint8Array.new(len(encoded_data))
    js_array.assign(my_stream.getbuffer())
    file = File.new([js_array], "unused_file_name.txt", {type: "text/plain"})
    url = URL.createObjectURL(file)
    hidden_link = document.createElement("a")
    hidden_link.setAttribute("download", "file.txt")
    hidden_link.setAttribute("href", url)
    hidden_link.click()
</py-script>
  </body>
</html>
